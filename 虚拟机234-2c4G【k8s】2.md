Service学习

1. **ClusterIP service**
2. **ClusterIP service with session affinity**
3. **ClusterIP with external IPs**
4. **ClusterIP service without any endpoints**
5. **Headless service**

```bash
kubectl create deploy redis-deploy --image=redis --replicas=2 --dry-run=client -o yaml
```

```yml
cat <<- 'eof' | kubectl apply -f - -n default 
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: redis-deploy
  name: redis-deploy
spec:
  replicas: 2
  selector:
    matchLabels:
      app: redis-deploy
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: redis-deploy
    spec:
      containers:
      - image: redis
        name: redis
        resources: {}
        ports:        
        - containerPort: 6379          
          name: redis
status: {}
eof
```

```yml
cat <<- 'eof' | kubectl apply -f - -n default 
#redis-clusterip.yaml
apiVersion: v1
kind: Service
metadata:  
  name: redis
spec:  
  ports:  
  - port: 6379  
  selector:    
    app: redis-deploy
eof
```

```bash
kubectl get endpoints redis
k exec -it busybox -- nslookup redis.default.svc.cluster.local
```

```bash
cat <<- 'eof' | kubectl apply -f - -n default 
#redis-clusterip-sa.yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-sa
spec:
  sessionAffinity: ClientIP
  ports:
  - port: 6379
  selector:
    app: redis-deploy
eof
```

如果不想创建 ClusterIP，可以声明 None 去掉 ClusterIP 支持，如下：

```yml
cat <<- 'eof' | kubectl apply -f - -n default 
#redis-clusterip-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-headless
spec:
  clusterIP: None
  ports:
  - port: 6379
  selector:
    app: redis-deploy
eof
```

```bash
k exec -it busybox -- nslookup redis-headless.default.svc.cluster.local
```

```bash
alias k=kubectl  
export now="--force --grace-period 0"   # k delete pod x $now
```

```bash
# Vim
# To make vim use 2 spaces for a tab edit ~/.vimrc to contain:
set tabstop=2
set expandtab
set shiftwidth=2
```

```bash
kubectl get po --sort-by {.metadata.creationTimestamp} -A
kubectl get po --sort-by {.metadata.uid} -A
```

```bash
kubectl run pod1 --image=httpd:2.4.41-alpine
```

```bash
apiVersion: v1
kind: Pod
metadata:
  labels:
    run: ready-if-service-ready
  name: ready-if-service-ready
spec:
  containers:
  - image: nginx:1.16.1-alpine
    name: ready-if-service-ready
    ports:
    - containerPort: 80
    readinessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
    livenessProbe:
      exec:
        command:
        - 'true'
      initialDelaySeconds: 5
      periodSeconds: 5
  dnsPolicy: ClusterFirst
  restartPolicy: Always
```

```yml
cat <<- 'eof' | kubectl apply -f - -n project-tiger
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: safari-pv
spec:
  capacity:
    storage: 2Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  hostPath:
    path: /Volumes/Data
...
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: safari-pvc
  namespace: project-tiger
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 2Gi
...
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: safari
  name: safari
  namespace: project-tiger
spec:
  replicas: 1
  selector:
    matchLabels:
      app: safari
  strategy: {}
  template:
    metadata:
      labels:
        app: safari
    spec:
      containers:
      - image: httpd:2.4.41-alpine
        name: safari
        resources: {}
        volumeMounts: #这里定义pod中要挂载的路径
        - name: safari
          mountPath: /tmp/safari-data
      volumes:
        - name: safari #和上面的挂载目录一致
          persistentVolumeClaim:
            claimName: safari-pvc #
...
eof
```

